# 🚀 外卖订单系统二次开发计划

## 📋 项目现状分析

### ✅ 现有优势
- **完整架构**：Next.js + Express.js + MySQL
- **微信集成**：已实现登录、支付、分享功能
- **用户系统**：完整的用户管理和认证
- **订单系统**：完整的订单创建和管理流程
- **支付系统**：支持微信、支付宝、易支付
- **测试环境**：完善的测试账户功能

### 🎯 开发目标
1. **客户白名单功能** - 控制访问权限
2. **用户自定义商品参数** - 提升用户体验
3. **订单返现系统** - 增加盈利模式（待定）

## 📅 开发计划时间线

### 🟢 第一阶段：客户白名单功能（1-2周）

#### **1.1 数据库设计**
```sql
-- 白名单用户表
CREATE TABLE whitelist_users (
  id INT PRIMARY KEY AUTO_INCREMENT,
  openid VARCHAR(100) UNIQUE NOT NULL,
  phone VARCHAR(20),
  nickname VARCHAR(100),
  status ENUM('active', 'inactive', 'pending') DEFAULT 'pending',
  added_by INT,
  added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  expires_at TIMESTAMP NULL,
  notes TEXT,
  FOREIGN KEY (added_by) REFERENCES user(id)
);

-- 白名单配置表
CREATE TABLE whitelist_config (
  id INT PRIMARY KEY AUTO_INCREMENT,
  enabled BOOLEAN DEFAULT FALSE,
  auto_approve BOOLEAN DEFAULT FALSE,
  max_users INT DEFAULT 1000,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### **1.2 后端API开发**
```javascript
// server/controllers/whitelistController.js
export const addToWhitelist = async (req, res) => {
  // 添加用户到白名单
};

export const removeFromWhitelist = async (req, res) => {
  // 从白名单移除用户
};

export const checkWhitelist = async (req, res) => {
  // 检查用户是否在白名单中
};

export const getWhitelistUsers = async (req, res) => {
  // 获取白名单用户列表
};
```

#### **1.3 前端管理界面**
```typescript
// client/src/app/admin/whitelist/page.tsx
export default function WhitelistManagement() {
  // 白名单管理页面
  // 添加/删除用户
  // 查看用户状态
  // 批量操作
}
```

#### **1.4 权限中间件**
```javascript
// server/middleware/whitelistMiddleware.js
export const whitelistCheck = async (req, res, next) => {
  const user = req.user;
  if (!user) return res.status(401).json({ error: '未登录' });
  
  const isWhitelisted = await checkUserInWhitelist(user.openid);
  if (!isWhitelisted) {
    return res.status(403).json({ error: '您不在白名单中，请联系管理员' });
  }
  
  next();
};
```

### 🟡 第二阶段：用户自定义商品参数（2-3周）

#### **2.1 数据库扩展**
```sql
-- 用户自定义商品表
CREATE TABLE custom_products (
  id INT PRIMARY KEY AUTO_INCREMENT,
  user_id INT NOT NULL,
  merchant_name VARCHAR(200),
  product_name VARCHAR(200),
  original_price DECIMAL(10,2),
  current_price DECIMAL(10,2),
  category_id INT,
  image_url VARCHAR(500),
  description TEXT,
  avatar_url VARCHAR(500),
  nickname VARCHAR(100),
  status ENUM('draft', 'active', 'inactive') DEFAULT 'draft',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES user(id),
  FOREIGN KEY (category_id) REFERENCES category(id)
);

-- 自定义商品规格表
CREATE TABLE custom_product_specs (
  id INT PRIMARY KEY AUTO_INCREMENT,
  custom_product_id INT NOT NULL,
  name VARCHAR(100),
  price DECIMAL(10,2),
  stock INT DEFAULT 1000,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (custom_product_id) REFERENCES custom_products(id)
);
```

#### **2.2 前端自定义界面**
```typescript
// client/src/app/custom-product/page.tsx
export default function CustomProductPage() {
  const [formData, setFormData] = useState({
    merchant_name: '',
    product_name: '',
    original_price: 0,
    current_price: 0,
    category_id: 1,
    image_url: '',
    avatar_url: '',
    nickname: '',
    description: ''
  });

  // 表单验证
  // 图片上传
  // 实时预览
  // 保存草稿
}
```

#### **2.3 商品模板系统**
```typescript
// client/src/components/ProductTemplates.tsx
const productTemplates = [
  {
    id: 1,
    name: '美团外卖',
    template: {
      merchant_name: 'XX餐厅',
      product_name: 'XX套餐',
      original_price: 0,
      current_price: 0,
      category_id: 2,
      image_url: '/templates/meituan.jpg',
      avatar_url: '',
      nickname: ''
    }
  },
  // 更多模板...
];
```

#### **2.4 订单集成**
```javascript
// server/controllers/orderController.js
export const createCustomOrder = async (req, res) => {
  const { custom_product_id, quantity, specs } = req.body;
  
  // 获取自定义商品信息
  const customProduct = await getCustomProduct(custom_product_id);
  
  // 创建订单
  const order = await createOrder({
    ...customProduct,
    quantity,
    specs
  });
  
  res.json(createResponse(200, "success", order));
};
```

### 🔴 第三阶段：订单返现系统（3-4周，待定）

#### **3.1 合规性分析**
```typescript
// 返现系统合规检查
interface ComplianceCheck {
  paymentLicense: boolean;      // 支付牌照
  taxRegistration: boolean;     // 税务登记
  antiMoneyLaundering: boolean; // 反洗钱
  userVerification: boolean;    // 用户实名
  auditTrail: boolean;          // 审计轨迹
}
```

#### **3.2 数据库设计**
```sql
-- 返现配置表
CREATE TABLE cashback_config (
  id INT PRIMARY KEY AUTO_INCREMENT,
  enabled BOOLEAN DEFAULT FALSE,
  rate DECIMAL(5,2) DEFAULT 0.70, -- 返现比例
  min_amount DECIMAL(10,2) DEFAULT 1.00,
  max_amount DECIMAL(10,2) DEFAULT 10000.00,
  daily_limit DECIMAL(10,2) DEFAULT 5000.00,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 返现记录表
CREATE TABLE cashback_records (
  id INT PRIMARY KEY AUTO_INCREMENT,
  order_id INT NOT NULL,
  user_id INT NOT NULL,
  amount DECIMAL(10,2),
  rate DECIMAL(5,2),
  status ENUM('pending', 'processing', 'completed', 'failed'),
  payment_method VARCHAR(50),
  payment_account VARCHAR(200),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (order_id) REFERENCES `order`(id),
  FOREIGN KEY (user_id) REFERENCES user(id)
);
```

#### **3.3 返现处理流程**
```javascript
// server/controllers/cashbackController.js
export const processCashback = async (orderId) => {
  // 1. 验证订单状态
  // 2. 计算返现金额
  // 3. 创建返现记录
  // 4. 处理返现支付
  // 5. 更新状态
};
```

## 🛡️ 微信端兼容性和限制规避

### 🔒 微信端安全策略

#### **4.1 域名和HTTPS配置**
```nginx
# nginx配置优化
server {
    listen 443 ssl http2;
    server_name yourdomain.com;
    
    # SSL配置
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    # 安全头
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000";
    
    # 微信JS-SDK域名配置
    location /wx/jsconfig {
        proxy_pass http://backend;
        proxy_set_header Host $host;
    }
}
```

#### **4.2 微信JS-SDK配置**
```typescript
// client/src/utils/wechatConfig.ts
export const wechatConfig = {
  // 确保域名在微信公众平台配置
  domain: 'https://yourdomain.com',
  
  // JS-SDK权限配置
  jsApiList: [
    'updateAppMessageShareData',
    'updateTimelineShareData',
    'chooseWXPay', // 支付权限
    'getLocation',  // 位置权限（如需要）
  ],
  
  // 安全配置
  debug: false,
  beta: false
};
```

#### **4.3 内容合规检查**
```typescript
// server/middleware/contentFilter.ts
export const contentFilter = (req, res, next) => {
  const { merchant_name, product_name, description } = req.body;
  
  // 敏感词过滤
  const sensitiveWords = ['赌博', '色情', '政治', '暴力'];
  const content = `${merchant_name} ${product_name} ${description}`;
  
  for (const word of sensitiveWords) {
    if (content.includes(word)) {
      return res.status(400).json({
        error: '内容包含敏感词汇，请修改后重试'
      });
    }
  }
  
  next();
};
```

#### **4.4 用户行为监控**
```javascript
// server/middleware/userBehavior.ts
export const monitorUserBehavior = (req, res, next) => {
  const user = req.user;
  const action = req.path;
  const timestamp = new Date();
  
  // 记录用户行为
  await logUserAction({
    user_id: user?.id,
    action,
    ip: req.ip,
    user_agent: req.get('User-Agent'),
    timestamp
  });
  
  // 检测异常行为
  const suspiciousActivity = await detectSuspiciousActivity(user?.id);
  if (suspiciousActivity) {
    return res.status(429).json({
      error: '检测到异常行为，请稍后重试'
    });
  }
  
  next();
};
```

## 📊 开发优先级和风险评估

### 🎯 优先级排序

| 功能 | 优先级 | 开发难度 | 合规风险 | 商业价值 |
|------|--------|----------|----------|----------|
| **客户白名单** | 🟢 高 | 🟢 低 | 🟢 低 | 🟢 高 |
| **自定义商品** | 🟢 高 | 🟡 中 | 🟢 低 | 🟢 高 |
| **订单返现** | 🟡 中 | 🔴 高 | 🔴 高 | 🟡 中 |

### ⚠️ 风险控制

#### **技术风险**
- **数据库性能**：添加索引优化查询
- **API安全**：加强参数验证和权限控制
- **前端兼容**：确保微信浏览器兼容性

#### **合规风险**
- **内容审核**：建立内容过滤机制
- **用户隐私**：遵循数据保护法规
- **支付合规**：确保支付流程合法

#### **业务风险**
- **用户体验**：保持界面简洁易用
- **功能稳定**：充分测试新功能
- **数据安全**：加强数据加密和备份

## 🚀 实施建议

### 📅 开发时间安排

#### **第1-2周：白名单功能**
- 数据库设计和创建
- 后端API开发
- 前端管理界面
- 权限中间件集成

#### **第3-5周：自定义商品功能**
- 数据库扩展
- 前端自定义界面
- 商品模板系统
- 订单系统集成

#### **第6-9周：返现系统（可选）**
- 合规性分析
- 数据库设计
- 返现处理逻辑
- 安全审计

### 🔧 技术栈保持

- **前端**：Next.js + TypeScript + TailwindCSS
- **后端**：Express.js + Node.js
- **数据库**：MySQL 8.0
- **部署**：Docker + Nginx

### 📋 质量保证

- **代码审查**：每个功能完成后进行代码审查
- **测试覆盖**：单元测试和集成测试
- **性能监控**：监控系统性能和用户体验
- **安全审计**：定期进行安全检查和漏洞扫描

## 🔧 测试账户使用说明

### 📱 启用测试账户

#### **方法1：修改前端配置**
```typescript
// client/src/components/LoginModal.tsx
const isDevelopment = true; // 改为 true 启用测试登录
```

#### **方法2：直接调用API**
```bash
curl -X POST https://yourdomain.com/v1/user/test-login \
  -H "Content-Type: application/json" \
  -d '{}'
```

### ✅ 测试账户功能
- **用户信息**：自动生成测试用户数据
- **订单创建**：支持完整订单流程
- **支付功能**：支持所有支付方式测试
- **分享功能**：支持微信分享测试
- **数据存储**：测试数据存储在真实数据库中

## 📝 开发日志

### 2024年开发记录
- [ ] 第一阶段：客户白名单功能开发
- [ ] 第二阶段：用户自定义商品参数功能开发
- [ ] 第三阶段：订单返现系统开发（待定）

---

**最后更新**：2024年12月
**版本**：v1.0
**状态**：开发中
