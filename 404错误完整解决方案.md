# ğŸ¯ 404é”™è¯¯å®Œæ•´è§£å†³æ–¹æ¡ˆ

## ğŸ“‹ ä½ å‘ç°çš„é—®é¢˜ï¼ˆéå¸¸æ­£ç¡®ï¼ï¼‰

### é—®é¢˜1: Frontendçš„ `/h5/config.js` 404 âŒ
```
GET https://waimaimeituan.dpdns.org/h5/config.js 
net::ERR_ABORTED 404 (Not Found)
```

### é—®é¢˜2: Backendæ‰€æœ‰é™æ€æ–‡ä»¶404 âŒ
```
GET https://waimaimeituan.dpdns.org/admin/libs/vue.global.js 404
GET https://waimaimeituan.dpdns.org/admin/libs/index.css 404
GET https://waimaimeituan.dpdns.org/admin/js/api.js 404
```

**ä½ çš„è¯Šæ–­å®Œå…¨æ­£ç¡®ï¼** ğŸ‘ è¿™ä¸¤ä¸ª404æ˜¯å¯¼è‡´ç½‘ç«™æ— æ³•æ­£å¸¸å·¥ä½œçš„**æ ¹æœ¬åŸå› **ã€‚

---

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### åŸå› 1: Frontendçš„ `basePath` é…ç½®é”™è¯¯

**æ–‡ä»¶**: `client/src/config/config.ts`

```typescript
export const basePath = '/h5';  // âŒ é”™è¯¯ï¼
```

**åæœ**ï¼š
- `layout.tsx` ä¸­ä½¿ç”¨ `${basePath}/config.js` 
- å¯¼è‡´è®¿é—® `/h5/config.js` è€Œä¸æ˜¯ `/config.js`
- ä½†Next.jså·²ç»æ³¨é‡Šæ‰äº† `next.config.ts` ä¸­çš„ `basePath: '/h5'`
- ä¸¤è€…ä¸ä¸€è‡´å¯¼è‡´404

**è§£å†³**ï¼š
```typescript
export const basePath = '';  // âœ… ç©ºå­—ç¬¦ä¸²ï¼Œä¸ä½¿ç”¨å‰ç¼€
```

---

### åŸå› 2: Nginxé™æ€æ–‡ä»¶è·¯ç”±ä¼˜å…ˆçº§é”™è¯¯

**æ–‡ä»¶**: `nginx/conf.d/default.conf`

**é”™è¯¯é…ç½®**ï¼š
```nginx
# ç®¡ç†åå°
location /admin/ {
    proxy_pass http://backend:4000/admin/;
}

# é™æ€æ–‡ä»¶ï¼ˆè¿™ä¸ªè§„åˆ™ä¼šæ‹¦æˆªæ‰€æœ‰.jsã€.cssæ–‡ä»¶ï¼ï¼‰
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
    proxy_pass http://frontend:3000;  # âŒ å‘é€åˆ°Frontendè€Œä¸æ˜¯Backendï¼
    expires 1y;
}
```

**é—®é¢˜æµç¨‹**ï¼š
1. æµè§ˆå™¨è¯·æ±‚ `/admin/libs/vue.global.js`
2. NginxåŒ¹é…è§„åˆ™ï¼š
   - âœ… åŒ¹é… `location /admin/` â†’ åº”è¯¥è½¬å‘åˆ°Backend
   - âŒ **ä½†æ˜¯**ï¼æ­£åˆ™è¡¨è¾¾å¼ `location ~*` çš„ä¼˜å…ˆçº§**é«˜äº**å‰ç¼€åŒ¹é… `location /admin/`
   - âŒ æ‰€ä»¥ `\.js$` è§„åˆ™æ‹¦æˆªäº†è¯·æ±‚
   - âŒ è¯·æ±‚è¢«å‘é€åˆ° `frontend:3000` è€Œä¸æ˜¯ `backend:4000`
3. Frontendæ²¡æœ‰ `/admin/libs/vue.global.js` â†’ 404

**Nginx locationä¼˜å…ˆçº§**ï¼š
```
1. = ç²¾ç¡®åŒ¹é…ï¼ˆæœ€é«˜ï¼‰
2. ^~ å‰ç¼€åŒ¹é…ï¼ˆåœæ­¢æ­£åˆ™æœç´¢ï¼‰
3. ~ å’Œ ~* æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼ˆæŒ‰é¡ºåºï¼‰
4. å‰ç¼€åŒ¹é…ï¼ˆæœ€ä½ï¼‰
```

**æ­£ç¡®é…ç½®**ï¼š
```nginx
# åç«¯APIï¼ˆä¼˜å…ˆï¼‰
location /v1/ {
    proxy_pass http://backend:4000/v1/;
}

# ç®¡ç†åå°ï¼ˆä¼˜å…ˆï¼ŒåŒ…æ‹¬æ‰€æœ‰é™æ€æ–‡ä»¶ï¼‰
location /admin/ {
    proxy_pass http://backend:4000/admin/;
}

# å‰ç«¯é™æ€æ–‡ä»¶ï¼ˆæ’é™¤adminç›®å½•ï¼‰
location ~* ^/(?!admin/).*\.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
    proxy_pass http://frontend:3000;
    expires 1y;
}

# å‰ç«¯æœåŠ¡ï¼ˆé»˜è®¤ï¼‰
location / {
    proxy_pass http://frontend:3000;
}
```

**å…³é”®ä¿®æ”¹**ï¼š
- `^/(?!admin/).*\.js$` - ä½¿ç”¨è´Ÿå‘å‰ç»ï¼ˆnegative lookaheadï¼‰æ’é™¤ `/admin/` ç›®å½•
- è°ƒæ•´äº†locationå—çš„é¡ºåºï¼Œä½†æ›´é‡è¦çš„æ˜¯ä½¿ç”¨æ­£åˆ™æ’é™¤

---

## âœ… å®Œæ•´ä¿®æ”¹æ¸…å•

### 1. `client/src/config/config.ts` âœ…
```diff
- export const basePath = '/h5';
+ export const basePath = '';
```

### 2. `nginx/conf.d/default.conf` âœ…
```diff
- location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
-     proxy_pass http://frontend:3000;
+ location ~* ^/(?!admin/).*\.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
+     proxy_pass http://frontend:3000;
```

### 3. `docker-compose.prod.yml` âœ… (ä¹‹å‰å·²ä¿®æ”¹)
```diff
  frontend:
    build:
      args:
+       NEXT_PUBLIC_API_URL: ${BASE_URL}/v1
-   volumes:
-     - ./client:/app
```

### 4. `client/Dockerfile.prod` âœ… (ä¹‹å‰å·²ä¿®æ”¹)
```diff
+ ARG NEXT_PUBLIC_API_URL
+ ENV NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
  RUN npm run build
```

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š

```bash
cd /opt/mini-shop
git pull
chmod +x ultimate-fix.sh
./ultimate-fix.sh
```

### è¿™ä¸ªè„šæœ¬ä¼šï¼š

1. âœ… æ‹‰å–æœ€æ–°ä»£ç ï¼ˆåŒ…å«ä¸¤ä¸ªå…³é”®ä¿®å¤ï¼‰
2. âœ… åœæ­¢æ‰€æœ‰å®¹å™¨
3. âœ… æ¸…ç†æ—§é•œåƒ
4. âœ… **é‡æ–°æ„å»ºFrontend**ï¼ˆbasePathå·²æ”¹ä¸ºç©ºï¼‰
5. âœ… é‡æ–°æ„å»ºBackend
6. âœ… å¯åŠ¨æ‰€æœ‰æœåŠ¡
7. âœ… æµ‹è¯•æ‰€æœ‰å…³é”®ç«¯ç‚¹
8. âœ… æ˜¾ç¤ºè¯¦ç»†çš„è¯Šæ–­ä¿¡æ¯

---

## ğŸ§ª éªŒè¯æ­¥éª¤

### âš ï¸ ç¬¬ä¸€æ­¥ï¼šæ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼ˆå¿…é¡»ï¼ï¼‰

**ä¸ºä»€ä¹ˆï¼Ÿ** æµè§ˆå™¨ç¼“å­˜äº†æ—§çš„ `config.js` æ–‡ä»¶ï¼ˆåŒ…å« `/h5` å‰ç¼€ï¼‰

**æ–¹æ³•**ï¼š
- `Ctrl + Shift + Delete` â†’ æ¸…é™¤ç¼“å­˜
- æˆ–ä½¿ç”¨æ— ç—•æ¨¡å¼ï¼š`Ctrl + Shift + N`
- æˆ–å¼ºåˆ¶åˆ·æ–°ï¼š`Ctrl + Shift + R`

### ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥Frontend

è®¿é—® `https://waimaimeituan.dpdns.org`ï¼ŒæŒ‰ `F12`ï¼š

**Consoleåº”è¯¥æ˜¾ç¤º**ï¼š
```javascript
APP_CONFIG {
  API_URL: 'https://waimaimeituan.dpdns.org/v1',
  ASSET_PREFIX: 'https://waimaimeituan.dpdns.org',
  WECHAT_APP_ID: 'wx24cf9fafe860e29d'
}
getBaseUrl https://waimaimeituan.dpdns.org/v1  âœ…
```

**Networkåº”è¯¥æ˜¾ç¤º**ï¼š
```
âœ… /config.js - 200 OK (ä¸å†æ˜¯/h5/config.js)
âœ… /v1/shop/categories - 200 OK
```

### ç¬¬ä¸‰æ­¥ï¼šæ£€æŸ¥Backendç®¡ç†åå°

è®¿é—® `https://waimaimeituan.dpdns.org/admin`ï¼ŒæŒ‰ `F12`ï¼š

**Networkåº”è¯¥æ˜¾ç¤º**ï¼š
```
âœ… /admin/libs/vue.global.js - 200 OK (ä¸å†404ï¼)
âœ… /admin/libs/index.css - 200 OK
âœ… /admin/libs/index.full.js - 200 OK
âœ… /admin/js/api.js - 200 OK
```

**é¡µé¢åº”è¯¥**ï¼š
- âœ… æ­£å¸¸æ˜¾ç¤ºç™»å½•ç•Œé¢ï¼ˆä¸æ˜¯ç©ºç™½ï¼‰
- âœ… å¯ä»¥è¾“å…¥ç”¨æˆ·åå¯†ç 
- âœ… å¯ä»¥æ­£å¸¸ç™»å½•ï¼ˆadmin / 123456ï¼‰

---

## ğŸ“Š ä¿®å¤å‰ vs ä¿®å¤åå¯¹æ¯”

### Frontend

| é¡¹ç›® | ä¿®å¤å‰ âŒ | ä¿®å¤å âœ… |
|------|----------|----------|
| config.jsè·¯å¾„ | `/h5/config.js` (404) | `/config.js` (200) |
| API URL | `localhost:4000` | `waimaimeituan.dpdns.org` |
| basePathé…ç½® | `/h5` | `` (ç©º) |

### Backendç®¡ç†åå°

| é¡¹ç›® | ä¿®å¤å‰ âŒ | ä¿®å¤å âœ… |
|------|----------|----------|
| vue.global.js | 404 (è¢«å‘é€åˆ°Frontend) | 200 (æ­£ç¡®å‘é€åˆ°Backend) |
| index.css | 404 | 200 |
| api.js | 404 | 200 |
| é¡µé¢æ˜¾ç¤º | ç©ºç™½ | æ­£å¸¸ç™»å½•ç•Œé¢ |

### Nginxè·¯ç”±

| è¯·æ±‚ | ä¿®å¤å‰ âŒ | ä¿®å¤å âœ… |
|------|----------|----------|
| `/admin/libs/vue.global.js` | â†’ Frontend (404) | â†’ Backend (200) |
| `/admin/index.html` | â†’ Backend (200) | â†’ Backend (200) |
| `/_next/static/chunks/xxx.js` | â†’ Frontend (200) | â†’ Frontend (200) |
| `/favicon.ico` | â†’ Frontend | â†’ Frontend |

---

## ğŸ¯ ä¸ºä»€ä¹ˆä¹‹å‰çš„ä¿®å¤æ²¡å®Œå…¨è§£å†³ï¼Ÿ

æˆ‘ä»¬ä¹‹å‰ä¿®å¤äº†ï¼š
1. âœ… Frontendæ„å»ºæ—¶ç¯å¢ƒå˜é‡ä¼ é€’
2. âœ… Docker volumeæŒ‚è½½è¦†ç›–é—®é¢˜
3. âœ… config.jsçš„API URLé…ç½®

ä½†**é—æ¼äº†**ï¼š
1. âŒ `basePath = '/h5'` ä»ç„¶å­˜åœ¨ï¼ˆå¯¼è‡´ `/h5/config.js` 404ï¼‰
2. âŒ Nginxé™æ€æ–‡ä»¶è·¯ç”±ä¼˜å…ˆçº§é”™è¯¯ï¼ˆå¯¼è‡´Backendçš„ `.js`/`.css` 404ï¼‰

**è¿™ä¸¤ä¸ªé—®é¢˜æ˜¯æœ€æ ¹æœ¬çš„åŸå› ï¼** ä½ é€šè¿‡æµè§ˆå™¨è¯Šæ–­å‡†ç¡®åœ°æ‰¾åˆ°äº†å®ƒä»¬ï¼ğŸ‘

---

## ğŸ“š æŠ€æœ¯çŸ¥è¯†ç‚¹

### 1. Next.jsçš„basePath

`basePath` ç”¨äºåœ¨å­è·¯å¾„ä¸‹éƒ¨ç½²åº”ç”¨ï¼š

```typescript
// next.config.ts
basePath: '/h5'  // åº”ç”¨éƒ¨ç½²åœ¨ https://example.com/h5/
```

**å½±å“**ï¼š
- æ‰€æœ‰è·¯ç”±å˜æˆ `/h5/...`
- é™æ€èµ„æºè·¯å¾„å˜æˆ `/h5/_next/...`
- éœ€è¦åœ¨ä»£ç ä¸­ä¹Ÿä½¿ç”¨ `basePath` å‰ç¼€

**æˆ‘ä»¬çš„æƒ…å†µ**ï¼š
- `next.config.ts` ä¸­å·²æ³¨é‡Šæ‰ `basePath: '/h5'`
- ä½† `config.ts` ä¸­ä»æœ‰ `basePath = '/h5'`
- ä¸ä¸€è‡´å¯¼è‡´404

### 2. Nginx locationä¼˜å…ˆçº§

```nginx
# ä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼š
location = /exact/path {}        # 1. ç²¾ç¡®åŒ¹é…
location ^~ /prefix/ {}          # 2. å‰ç¼€åŒ¹é…ï¼ˆåœæ­¢æ­£åˆ™ï¼‰
location ~ \.php$ {}             # 3. æ­£åˆ™è¡¨è¾¾å¼ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰
location ~* \.(js|css)$ {}       # 4. æ­£åˆ™è¡¨è¾¾å¼ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
location /prefix/ {}             # 5. æ™®é€šå‰ç¼€åŒ¹é…
location / {}                    # 6. é»˜è®¤åŒ¹é…
```

**æˆ‘ä»¬çš„é—®é¢˜**ï¼š
- `location ~* \.(js|css)$` ä¼˜å…ˆçº§é«˜äº `location /admin/`
- è§£å†³æ–¹æ³•ï¼šä½¿ç”¨è´Ÿå‘å‰ç»æ’é™¤ `/admin/` ç›®å½•

### 3. Docker volumeæŒ‚è½½é™·é˜±

```yaml
# å¼€å‘ç¯å¢ƒ âœ…
volumes:
  - ./client:/app  # çƒ­é‡è½½

# ç”Ÿäº§ç¯å¢ƒ âŒ
volumes:
  - ./client:/app  # è¦†ç›–æ„å»ºäº§ç‰©ï¼
```

---

## âœ… ç°åœ¨ä¸€åˆ‡åº”è¯¥å®Œç¾äº†ï¼

è¿è¡Œ `./ultimate-fix.sh` åï¼š

âœ… Frontendä¸å†è¯·æ±‚ `/h5/config.js`  
âœ… Frontend APIè¯·æ±‚å‘é€åˆ°æ­£ç¡®çš„åŸŸå  
âœ… Backendé™æ€æ–‡ä»¶é€šè¿‡Nginxæ­£ç¡®è½¬å‘  
âœ… ç®¡ç†åå°å®Œæ•´æ˜¾ç¤º  
âœ… å¯ä»¥æ­£å¸¸ç™»å½•å’Œä½¿ç”¨  

---

## ğŸ‰ æ­å–œï¼

ä½ é€šè¿‡ä»”ç»†è§‚å¯Ÿæµè§ˆå™¨çš„404é”™è¯¯ï¼Œæ‰¾åˆ°äº†é—®é¢˜çš„**çœŸæ­£æ ¹æº**ï¼

è¿™æ˜¯éå¸¸å¥½çš„è°ƒè¯•æŠ€å·§ï¼š
1. âœ… æŸ¥çœ‹æµè§ˆå™¨Networkæ ‡ç­¾
2. âœ… æ‰¾åˆ°å…·ä½“çš„404è¯·æ±‚
3. âœ… åˆ†æè·¯å¾„å’Œæ¥æº
4. âœ… å®šä½é…ç½®é—®é¢˜

ç°åœ¨ç½‘ç«™åº”è¯¥å®Œå…¨æ­£å¸¸äº†ï¼ğŸš€ğŸŠ

