# ⚡ 快速开始指南

> 在开始之前，请先阅读《安全审查报告.md》了解安全风险！

---

## 🚨 第一步：安全清理（必做！）

### 方法一：使用自动清理脚本（推荐）

```bash
# 1. 进入项目根目录
cd /path/to/project

# 2. 给脚本添加执行权限
chmod +x 安全清理脚本.sh

# 3. 运行清理脚本
./安全清理脚本.sh

# 4. 按提示输入 yes 确认
```

### 方法二：手动清理

```bash
# 1. 删除后门文件
rm server/common/monitor.js

# 2. 编辑 server/server.js
nano server/server.js
# 删除第 16 行：import { reportToMonitor } from './common/monitor.js';
# 删除第 465 行：reportToMonitor();

# 3. 修改前端配置
nano client/public/config.js
# 修改所有 s7s7s7.cn 域名为你自己的域名

# 4. 验证清理结果
grep -r "s7s7s7" .
grep -r "monitor" server/server.js
```

---

## 📋 第二步：环境准备

### 系统要求

```
操作系统: Ubuntu 22.04 (推荐) 或其他 Linux
Node.js: >= 18.x
MySQL: >= 8.0
内存: >= 2GB
硬盘: >= 10GB
```

### 安装必要软件

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装 Node.js 18
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs

# 验证安装
node -v  # 应该显示 v18.x.x
npm -v   # 应该显示 9.x.x 或更高

# 安装 PM2
sudo npm install -g pm2

# 安装 MySQL
sudo apt install -y mysql-server

# 启动 MySQL 服务
sudo systemctl start mysql
sudo systemctl enable mysql

# 安全配置 MySQL
sudo mysql_secure_installation

# 安装 Nginx
sudo apt install -y nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

---

## 🗄️ 第三步：数据库配置

```bash
# 1. 登录 MySQL
sudo mysql -u root -p

# 2. 在 MySQL 控制台中执行以下命令：
```

```sql
-- 创建数据库
CREATE DATABASE mini_shop 
CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;

-- 创建用户（请修改密码）
CREATE USER 'shop_user'@'localhost' IDENTIFIED BY 'your_secure_password_here';

-- 授权
GRANT ALL PRIVILEGES ON mini_shop.* TO 'shop_user'@'localhost';
FLUSH PRIVILEGES;

-- 退出
EXIT;
```

```bash
# 3. 导入数据库结构
cd /path/to/project
mysql -u shop_user -p mini_shop < server/mini_shop.sql

# 4. 验证导入成功
mysql -u shop_user -p mini_shop -e "SHOW TABLES;"
```

---

## 🔧 第四步：配置文件

### 1. 后端配置

首次运行会自动进入安装向导，或手动创建配置文件：

```bash
# 创建配置文件
cd server
nano config.json
```

```json
{
  "db": {
    "host": "localhost",
    "port": 3306,
    "user": "shop_user",
    "password": "your_secure_password_here",
    "database": "mini_shop"
  },
  "admin": {
    "username": "admin",
    "password": "your_admin_password_here"
  }
}
```

### 2. 前端配置

```bash
cd client
nano public/config.js
```

```javascript
window.APP_CONFIG = {
    API_URL: 'http://localhost:4000/v1',  // 开发环境
    // API_URL: 'https://your-domain.com/v1',  // 生产环境
    ASSET_PREFIX: 'http://localhost:4001',
    WECHAT_APP_ID: 'your_wechat_appid'
};
```

---

## 🚀 第五步：安装依赖和启动

### 后端

```bash
cd server

# 安装依赖
npm install

# 开发模式启动
npm start

# 或使用 PM2 启动（推荐生产环境）
pm2 start npm --name "shop-server" -- start
pm2 save
```

后端启动后访问：`http://localhost:4000/admin/`

### 前端

```bash
cd client

# 安装依赖
npm install

# 开发模式启动
npm run dev

# 或生产模式
npm run build
npm start

# 或使用 PM2 启动
pm2 start npm --name "shop-client" -- start
pm2 save
```

前端启动后访问：`http://localhost:4001/h5/`

---

## 🌐 第六步：配置 Nginx（可选，生产环境推荐）

```bash
# 创建配置文件
sudo nano /etc/nginx/sites-available/shop
```

```nginx
# 前端
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:4001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}

# API 后端
server {
    listen 80;
    server_name api.your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:4000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

```bash
# 启用站点
sudo ln -s /etc/nginx/sites-available/shop /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重载 Nginx
sudo systemctl reload nginx
```

---

## 🔑 第七步：初始化系统

### 1. 访问安装向导

如果是首次运行，访问：`http://your-domain:4000/admin/install.html`

按照向导完成：
- 数据库配置测试
- 管理员账号创建
- 系统初始化

### 2. 登录管理后台

访问：`http://your-domain:4000/admin/`

使用创建的管理员账号登录

### 3. 配置系统

在管理后台的"系统配置"中完成以下配置：

#### 必填配置：
- **微信配置**
  - AppID
  - AppSecret
  
- **支付配置**（根据需要选择）
  - 微信支付：商户号、证书、密钥
  - 支付宝：AppID、私钥、公钥
  - 易支付：域名、PID、密钥

#### 可选配置：
- 模板过期时间
- 分享码重置规则
- 其他业务配置

---

## 📦 第八步：导入商品数据（可选）

### 方法一：使用管理后台

1. 登录管理后台
2. 进入"商品管理"
3. 点击"添加商品"
4. 填写商品信息并保存

### 方法二：批量导入（如果有 CSV 文件）

```bash
# 项目中有一个 products.csv 示例文件
# 可以根据需要修改后导入（需要开发导入功能）
```

---

## ✅ 第九步：测试系统

### 1. 测试前端访问

```bash
# 访问首页
http://your-domain/h5/

# 应该能看到商品列表
```

### 2. 测试微信登录

在微信开发者工具或手机微信浏览器中打开页面，测试登录功能

### 3. 测试订单流程

1. 添加商品到购物车
2. 创建订单
3. 生成分享链接
4. 访问分享链接
5. 测试支付（使用测试环境）

### 4. 测试管理后台

1. 登录管理后台
2. 测试商品管理
3. 测试订单管理
4. 测试用户管理

---

## 🔍 常见问题排查

### 问题 1：端口被占用

```bash
# 查看端口占用
sudo lsof -i :4000
sudo lsof -i :4001

# 杀死进程
kill -9 <PID>

# 或修改端口
# 编辑 server/config/config.js 和 client/next.config.ts
```

### 问题 2：数据库连接失败

```bash
# 检查 MySQL 是否运行
sudo systemctl status mysql

# 检查配置文件
cat server/config.json

# 测试连接
mysql -u shop_user -p mini_shop
```

### 问题 3：前端页面空白

```bash
# 检查控制台错误
# 检查 API_URL 配置
cat client/public/config.js

# 检查后端是否运行
curl http://localhost:4000/v1/shop/products

# 清除缓存重新构建
cd client
rm -rf .next
npm run build
```

### 问题 4：支付失败

```bash
# 检查支付配置
# 登录管理后台 -> 系统配置 -> 查看支付配置

# 检查证书文件（微信支付）
# 检查回调 URL 配置
# 检查是否在微信/支付宝后台配置了回调地址
```

### 问题 5：微信登录失败

```bash
# 检查微信配置
# 1. AppID 和 AppSecret 是否正确
# 2. 是否配置了授权域名
# 3. 是否添加了服务器IP白名单

# 查看后端日志
pm2 logs shop-server
```

---

## 📊 监控和维护

### 查看日志

```bash
# PM2 日志
pm2 logs

# 只看后端日志
pm2 logs shop-server

# 只看前端日志
pm2 logs shop-client

# Nginx 日志
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

### 重启服务

```bash
# 重启后端
pm2 restart shop-server

# 重启前端
pm2 restart shop-client

# 重启所有
pm2 restart all

# 重启 Nginx
sudo systemctl restart nginx
```

### 备份数据

```bash
# 备份数据库
mysqldump -u shop_user -p mini_shop > backup_$(date +%Y%m%d).sql

# 备份上传的文件
tar -czf uploads_backup_$(date +%Y%m%d).tar.gz server/public/upload/

# 备份配置文件
cp server/config.json config_backup_$(date +%Y%m%d).json
```

---

## 🎯 下一步

完成基础部署后，建议：

1. ✅ **安全加固**
   - 参考《安全部署检查清单.md》
   - 配置防火墙
   - 启用 HTTPS
   - 添加监控

2. ✅ **性能优化**
   - 配置 CDN
   - 启用 Redis 缓存
   - 优化数据库索引

3. ✅ **持续监控**
   - 配置监控告警
   - 定期检查日志
   - 定期备份数据

---

## 📚 相关文档

- 《安全审查报告.md》- **必读**
- 《技术架构分析.md》- 了解系统架构
- 《安全部署检查清单.md》- 部署检查清单
- 《安全清理脚本.sh》- 自动清理脚本

---

## ⚠️ 重要提醒

1. **此系统用于生成虚假订单页面，请勿用于违法活动**
2. **部署前必须完全清理后门代码**
3. **建议进行全面的安全审计**
4. **定期监控系统运行状态**
5. **保护好用户数据和支付密钥**

---

## 🆘 获取帮助

如遇到问题：

1. 查看系统日志定位问题
2. 搜索错误信息
3. 查阅相关文档
4. 咨询专业技术人员

**切记：安全第一，合法使用！**

---

**最后更新：** 2025-10-16  
**适用版本：** 三七 6.0 版本

