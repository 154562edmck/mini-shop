# 🔒 安全部署检查清单

在部署此外卖系统之前，请**务必**完成以下所有检查项。

---

## ✅ 清理前检查（必做）

- [ ] 已阅读《安全审查报告.md》
- [ ] 已理解此系统包含的后门代码
- [ ] 已备份原始源码（以防需要对比）
- [ ] 已理解使用此类系统的法律风险

---

## ✅ 恶意代码清理（必做）

### 1. 后门文件删除

- [ ] 已删除 `server/common/monitor.js` 或使用清理脚本
- [ ] 已从 `server/server.js` 删除以下行：
  ```javascript
  import { reportToMonitor } from './common/monitor.js';  // 第16行
  reportToMonitor();  // 第465行
  ```

### 2. 配置文件修改

- [ ] 已修改 `client/public/config.js`，移除 `s7s7s7.cn` 域名
  ```javascript
  window.APP_CONFIG = {
      API_URL: 'https://你的域名/v1',  // ⚠️ 必须修改
      ASSET_PREFIX: 'https://你的域名',  // ⚠️ 必须修改
      WECHAT_APP_ID: '你的微信AppID'  // ⚠️ 必须修改
  };
  ```

### 3. 代码审查

- [ ] 已执行命令搜索可疑域名：
  ```bash
  grep -r "s7s7s7" .
  grep -r "\.cn" . | grep -v node_modules
  ```
- [ ] 已搜索所有 HTTP 请求：
  ```bash
  grep -r "axios\." server/ | grep -v node_modules
  grep -r "fetch(" server/ | grep -v node_modules
  ```
- [ ] 已检查所有找到的网络请求，确认都是合法的（微信、支付宝等）

---

## ✅ 配置准备（必做）

### 1. 数据库配置

- [ ] 已安装 MySQL 8.0+
- [ ] 已创建数据库和用户
- [ ] 已导入 `server/mini_shop.sql`
- [ ] 数据库连接测试成功

### 2. 微信配置

- [ ] 已申请微信公众号
- [ ] 已获取 AppID 和 AppSecret
- [ ] 已配置授权域名
- [ ] 已配置服务器IP白名单

### 3. 支付配置

根据需要配置以下一种或多种支付方式：

#### 微信支付
- [ ] 已申请微信支付商户号
- [ ] 已获取商户证书
- [ ] 已获取 API v3 密钥
- [ ] 已配置支付回调URL

#### 支付宝
- [ ] 已申请支付宝商户
- [ ] 已生成应用私钥和公钥
- [ ] 已在支付宝开放平台配置公钥
- [ ] 已配置回调URL

#### 易支付（第三方）
- [ ] 已获取易支付商户信息
- [ ] 已配置密钥
- [ ] 已测试支付接口

### 4. 服务器配置

- [ ] 已准备 Linux 服务器（推荐 Ubuntu 22.04）
- [ ] 已安装 Node.js 18+
- [ ] 已安装 Nginx 或其他反向代理
- [ ] 已配置 SSL 证书（HTTPS）
- [ ] 已配置防火墙规则
- [ ] 已安装进程管理工具（PM2）

---

## ✅ 安全加固（强烈建议）

### 1. 服务器安全

- [ ] 已禁用 root 远程登录
- [ ] 已设置强密码策略
- [ ] 已配置 SSH 密钥登录
- [ ] 已安装 fail2ban 防暴力破解
- [ ] 已配置自动安全更新
- [ ] 已设置文件权限（node 用户运行，非 root）

### 2. 应用安全

- [ ] 已修改默认管理员账号密码
- [ ] 已设置复杂的数据库密码
- [ ] 已禁用不必要的端口
- [ ] 已配置 CORS 白名单
- [ ] 已启用请求频率限制
- [ ] 已配置日志记录

### 3. 数据安全

- [ ] 已配置数据库定期备份
- [ ] 已启用数据库访问日志
- [ ] 已限制数据库仅本地访问
- [ ] 已加密敏感配置文件

---

## ✅ 部署前测试（必做）

### 1. 功能测试

- [ ] 用户注册登录正常
- [ ] 商品列表显示正常
- [ ] 订单创建流程正常
- [ ] 支付流程完整（测试环境）
- [ ] 分享链接生成正常
- [ ] 管理后台登录正常

### 2. 安全测试

- [ ] 使用网络抓包工具监控 5 分钟，确认无异常外连
- [ ] 检查进程列表，确认无异常进程
- [ ] 检查定时任务，确认无异常任务
- [ ] 检查 netstat 输出，确认无可疑连接
  ```bash
  netstat -an | grep ESTABLISHED
  ```

### 3. 性能测试

- [ ] 页面加载速度测试
- [ ] 并发用户测试
- [ ] 数据库查询优化
- [ ] 静态资源 CDN 配置

---

## ✅ 部署步骤（按顺序执行）

### 步骤 1: 环境准备
```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装 Node.js
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs

# 安装 PM2
sudo npm install -g pm2

# 安装 MySQL
sudo apt install -y mysql-server

# 安装 Nginx
sudo apt install -y nginx
```

### 步骤 2: 数据库初始化
```bash
# 登录 MySQL
sudo mysql -u root -p

# 创建数据库
CREATE DATABASE mini_shop CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'shop_user'@'localhost' IDENTIFIED BY '强密码';
GRANT ALL PRIVILEGES ON mini_shop.* TO 'shop_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;

# 导入数据结构
mysql -u shop_user -p mini_shop < server/mini_shop.sql
```

### 步骤 3: 后端部署
```bash
cd server

# 安装依赖
npm install --production

# 首次运行（进入安装向导）
npm start

# 访问 http://服务器IP:4000/admin/install.html 完成安装

# 测试成功后，使用 PM2 启动
pm2 start npm --name "shop-server" -- start
pm2 save
pm2 startup
```

### 步骤 4: 前端部署
```bash
cd client

# 确认已修改 public/config.js
cat public/config.js

# 安装依赖
npm install --production

# 构建
npm run build

# 使用 PM2 启动
pm2 start npm --name "shop-client" -- start
pm2 save
```

### 步骤 5: Nginx 配置
```bash
# 编辑 Nginx 配置
sudo nano /etc/nginx/sites-available/shop

# 配置内容见下方
# 启用站点
sudo ln -s /etc/nginx/sites-available/shop /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重载 Nginx
sudo systemctl reload nginx
```

**Nginx 配置示例：**
```nginx
# 前端
server {
    listen 80;
    server_name 你的域名;
    
    # 重定向到 HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name 你的域名;
    
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    location / {
        proxy_pass http://127.0.0.1:4001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# API 后端
server {
    listen 80;
    server_name api.你的域名;
    
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name api.你的域名;
    
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    location / {
        proxy_pass http://127.0.0.1:4000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 步骤 6: SSL 证书配置
```bash
# 使用 Certbot 获取免费 SSL 证书
sudo apt install -y certbot python3-certbot-nginx
sudo certbot --nginx -d 你的域名 -d api.你的域名
```

---

## ✅ 部署后监控（持续进行）

### 1. 日常监控

- [ ] 每天检查系统日志
  ```bash
  pm2 logs
  sudo tail -f /var/log/nginx/error.log
  ```

- [ ] 每周检查网络连接
  ```bash
  netstat -tupln | grep node
  ```

- [ ] 每月审查数据库访问日志

### 2. 安全监控

- [ ] 配置入侵检测系统（如 AIDE）
- [ ] 配置文件完整性监控
- [ ] 配置异常流量告警
- [ ] 定期扫描漏洞

### 3. 性能监控

- [ ] 配置服务器资源监控（CPU、内存、磁盘）
- [ ] 配置应用性能监控（APM）
- [ ] 配置数据库慢查询日志

---

## ✅ 应急响应计划

### 如果发现安全问题：

1. **立即行动**
   - [ ] 断开服务器网络连接
   - [ ] 停止所有服务
   - [ ] 保存日志和取证数据

2. **问题分析**
   - [ ] 检查所有日志文件
   - [ ] 检查文件修改时间
   - [ ] 分析网络流量记录

3. **恢复步骤**
   - [ ] 从备份恢复干净的代码
   - [ ] 重置所有密码
   - [ ] 重新部署系统
   - [ ] 通知受影响的用户

---

## ⚖️ 法律合规检查

- [ ] 已了解《网络安全法》相关规定
- [ ] 已了解《个人信息保护法》相关规定
- [ ] 已准备用户隐私政策
- [ ] 已准备用户服务协议
- [ ] 已实施数据安全措施
- [ ] 已建立数据泄露应急预案

### ⚠️ 严重警告

此系统的主要功能是生成**虚假订单页面**，用于：
- 仿冒外卖平台界面
- 诱导用户支付

使用此系统进行以下行为均属**违法**：
1. 诈骗活动（诈骗罪）
2. 洗钱活动（洗钱罪）
3. 非法经营支付业务（非法经营罪）
4. 侵犯知识产权（侵权）

**量刑参考：**
- 诈骗罪：3年以上10年以下有期徒刑
- 数额特别巨大：10年以上有期徒刑或无期徒刑

**请勿用于任何违法活动！**

---

## 📞 获取帮助

如果在部署过程中遇到问题：

1. **技术问题**
   - 查看系统日志
   - 搜索错误信息
   - 咨询专业开发人员

2. **安全问题**
   - 联系网络安全专家
   - 进行专业安全审计
   - 考虑放弃使用此源码

3. **法律问题**
   - 咨询专业律师
   - 了解相关法律法规
   - 评估法律风险

---

## ✅ 最终确认

在正式上线前，请确认：

- [ ] 我已完成所有上述检查项
- [ ] 我已完全理解此系统的安全风险
- [ ] 我已完全理解此系统的法律风险
- [ ] 我承诺不将此系统用于任何违法活动
- [ ] 我已做好持续监控和维护的准备

---

**签署日期：** _______________

**部署负责人：** _______________

**审核人：** _______________

---

**最后提醒：如果对安全性有任何疑虑，建议不要部署此系统！**

