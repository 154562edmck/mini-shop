# 📊 外卖系统技术架构分析

## 一、系统概述

这是一个基于 **Node.js** 的全栈外卖订单系统，主要用于生成虚假外卖订单页面。

### 核心技术栈

**前端：**
- Next.js 15.1.4 (React 19)
- TypeScript
- TailwindCSS + NextUI
- Axios (HTTP 客户端)

**后端：**
- Node.js + Express.js
- MySQL 2
- ES Modules

**支付集成：**
- 微信支付 (wechatpay-node-v3)
- 支付宝 (alipay-sdk)
- 易支付 (第三方)

---

## 二、系统架构

```
┌─────────────────────────────────────────────────────────┐
│                        用户层                            │
│  (微信浏览器/普通浏览器访问虚假外卖订单页面)              │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│                      前端层 (Next.js)                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  订单模板    │  │  支付页面    │  │  用户中心    │  │
│  │  - 美团      │  │  - 微信支付  │  │  - 订单列表  │  │
│  │  - 饿了么    │  │  - 支付宝    │  │  - 地址管理  │  │
│  │  - 京东      │  │  - 易支付    │  │              │  │
│  │  - 拼多多... │  │              │  │              │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└────────────────────┬────────────────────────────────────┘
                     │ HTTPS/API
                     ▼
┌─────────────────────────────────────────────────────────┐
│                    后端层 (Express.js)                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  用户认证    │  │  订单管理    │  │  支付处理    │  │
│  │  - 微信登录  │  │  - 创建订单  │  │  - 微信支付  │  │
│  │  - JWT Token │  │  - 订单查询  │  │  - 支付宝    │  │
│  │              │  │  - 分享链接  │  │  - 回调处理  │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  商品管理    │  │  地址管理    │  │  管理后台    │  │
│  │  - 商品列表  │  │  - CRUD      │  │  - 商品管理  │  │
│  │  - 分类管理  │  │              │  │  - 订单管理  │  │
│  │  - 规格管理  │  │              │  │  - 配置管理  │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│                      数据层 (MySQL)                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  用户表      │  │  订单表      │  │  商品表      │  │
│  │  地址表      │  │  订单项表    │  │  分类表      │  │
│  │              │  │              │  │  规格表      │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                    ⚠️ 恶意后门层                         │
│  ┌──────────────────────────────────────────────────┐  │
│  │  monitor.js (已混淆)                              │  │
│  │  - 收集系统信息                                   │  │
│  │  - 上报到远程服务器 (s7s7s7.cn)                  │  │
│  │  - 接收并执行远程命令                             │  │
│  │  - 定时自动运行                                   │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

---

## 三、数据库设计

### 主要数据表

1. **user (用户表)**
   ```sql
   - id: 用户ID
   - openid: 微信OpenID
   - unionid: 微信UnionID
   - nickname: 昵称
   - avatar: 头像
   - phone: 手机号
   - create_time: 创建时间
   ```

2. **order (订单表)**
   ```sql
   - id: 订单ID
   - order_no: 订单号
   - user_id: 用户ID
   - total_amount: 总金额
   - status: 状态 (0:未支付, 1:已支付, 2:已过期)
   - address_id: 地址ID
   - pay_method: 支付方式
   - share_code: 分享码
   - expire_time: 过期时间
   - pay_time: 支付时间
   ```

3. **order_item (订单项表)**
   ```sql
   - id: 订单项ID
   - order_id: 订单ID
   - product_id: 商品ID
   - product_name: 商品名称
   - product_image: 商品图片
   - price: 价格
   - quantity: 数量
   - spec_id: 规格ID
   - spec_name: 规格名称
   ```

4. **product (商品表)**
   ```sql
   - id: 商品ID
   - name: 商品名称
   - description: 描述
   - image: 图片
   - price: 价格
   - stock: 库存
   - category_id: 分类ID
   - is_on_sale: 是否上架
   - is_promotion: 是否促销
   - merchant_name: 商家名称
   ```

5. **address (地址表)**
   ```sql
   - id: 地址ID
   - user_id: 用户ID
   - receiver: 收货人
   - phone: 电话
   - province: 省
   - city: 市
   - district: 区
   - detail: 详细地址
   - is_default: 是否默认
   ```

6. **system_config (系统配置表)**
   ```sql
   - id: 配置ID
   - key: 配置键
   - value: 配置值
   - description: 描述
   ```

---

## 四、核心功能模块

### 1. 用户认证模块

**文件：** `server/controllers/userController.js`

**流程：**
```
用户 → 微信授权 → 获取code → 后端换取access_token 
    → 获取用户信息 → 创建/更新用户 → 生成JWT token → 返回前端
```

**关键 API：**
- `POST /v1/user/wechat/login` - 微信登录
- `GET /v1/user/info` - 获取用户信息

### 2. 订单系统

**文件：** `server/controllers/orderController.js`

**核心功能：**
1. **创建订单**
   - 验证商品库存
   - 计算总价
   - 生成订单号
   - 创建订单记录

2. **分享订单**
   - 生成唯一分享码 (格式: `{templateId}_{uuid}`)
   - 设置过期时间（根据模板不同）
   - 生成分享链接

3. **查看分享订单**
   - 支持旧链接兼容（可配置）
   - 自动检测过期状态
   - 返回订单详情和商品列表

**关键 API：**
- `POST /v1/shop/orders` - 创建订单
- `GET /v1/shop/orders` - 获取订单列表
- `GET /v1/shop/orders/:orderNo` - 获取订单详情
- `POST /v1/shop/orders/:orderNo/share` - 创建分享链接
- `GET /v1/share/:shareCode` - 查看分享订单

### 3. 支付系统

#### 微信支付
**文件：** `server/controllers/payController.js`

**流程：**
```
前端 → 创建支付 → 后端统一下单 → 返回支付参数 
    → 前端调起支付 → 支付成功 → 回调通知 → 更新订单状态
```

**关键功能：**
- JSAPI 支付（公众号内支付）
- 支付回调验证
- 订单状态更新

#### 支付宝
**文件：** `server/controllers/alipayController.js`

**支持类型：**
- 手机网站支付
- 当面付（扫码支付）

#### 易支付（第三方）
**文件：** `server/controllers/easyPayController.js`

**支持：**
- 微信支付
- 支付宝
- QQ支付

### 4. 商品管理

**文件：** 
- `server/controllers/shopController.js` (前台)
- `server/admin/controllers/productController.js` (后台)

**功能：**
- 商品 CRUD
- 分类管理
- 规格管理
- 库存管理
- 图片上传

### 5. 管理后台

**目录：** `server/admin/` 和 `server/public/admin/`

**采用技术：** Vue.js 3 (CDN方式)

**功能模块：**
- Dashboard 数据统计
- 用户管理
- 商品管理
- 订单管理
- 系统配置
- 文件上传

---

## 五、前端模板系统

### 支持的外卖平台模板

**目录：** `client/src/app/share/[shareCode]/templates/`

1. **Meituan.tsx** - 美团外卖
2. **ELM.tsx** - 饿了么
3. **JD.tsx** - 京东到家
4. **PDD.tsx** - 拼多多
5. **DiDi2.tsx** - 滴滴出行
6. **CTrip2.tsx** - 携程旅行
7. **DW.tsx** - 得物
8. **DY.tsx** - 抖音
9. **FZ.tsx** - 肥宅
10. **MY.tsx** - 某平台
11. **TB.tsx** - 淘宝

### 模板特点

- **高度仿真**：模仿真实平台的 UI 设计
- **动态数据**：从后端获取真实订单数据
- **倒计时**：显示订单过期倒计时
- **二维码**：生成支付二维码
- **响应式**：适配各种手机屏幕

### 分享链接格式

```
https://你的域名/h5/share/{模板ID}_{随机码}

示例：
https://example.com/h5/share/1_a1b2c3d4  (美团模板)
https://example.com/h5/share/2_e5f6g7h8  (饿了么模板)
```

---

## 六、配置系统

### 配置文件层次

1. **config.json** (服务器根目录)
   ```json
   {
     "db": {
       "host": "localhost",
       "port": 3306,
       "user": "root",
       "password": "password",
       "database": "mini_shop"
     },
     "admin": {
       "username": "admin",
       "password": "password"
     }
   }
   ```

2. **system_config 数据表**
   - 存储系统运行时配置
   - 可通过管理后台修改
   - 包括支付配置、模板配置等

3. **前端配置** (client/public/config.js)
   ```javascript
   window.APP_CONFIG = {
       API_URL: 'https://你的域名/v1',
       ASSET_PREFIX: 'https://你的域名',
       WECHAT_APP_ID: '你的AppID'
   };
   ```

### 配置加载流程

```
1. 启动时读取 config.json
2. 连接数据库
3. 读取 system_config 表
4. 合并到 process.env
5. 初始化支付 SDK
```

---

## 七、安全机制（原有的，不包括后门）

### 1. 认证授权

- **JWT Token** 机制
- Token 存储在 localStorage
- API 请求携带 Authorization header
- 中间件验证 token 有效性

**文件：** `server/middlewares/authMiddleware.js`

### 2. CORS 配置

```javascript
cors({
    origin: "*",  // ⚠️ 允许所有来源（不安全）
    methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
    credentials: true
})
```

**⚠️ 安全问题**：允许所有来源访问，建议改为白名单。

### 3. Session 管理

- 使用 express-session
- Session 存储在 MySQL (express-mysql-session)
- Cookie 有效期：24小时

### 4. 支付签名验证

- 微信支付：验证签名和回调通知
- 支付宝：验证签名
- 易支付：密钥验证

---

## 八、部署架构

### 推荐部署方案

```
                    Internet
                       │
                       │
                    [Nginx]
                    (SSL/HTTPS)
                       │
         ┌─────────────┴─────────────┐
         │                           │
    [前端服务]                   [后端API]
  Next.js:4001               Express:4000
         │                           │
         └─────────────┬─────────────┘
                       │
                   [MySQL:3306]
```

### 端口配置

- **前端：** 4001
- **后端：** 4000
- **MySQL：** 3306

### PM2 进程管理

```bash
pm2 start npm --name "shop-server" -- start
pm2 start npm --name "shop-client" -- start
pm2 save
pm2 startup
```

---

## 九、性能优化

### 前端优化

1. **Next.js 特性**
   - 服务端渲染 (SSR)
   - 静态生成 (SSG)
   - 图片优化 (next/image)
   - 代码分割

2. **资源优化**
   - TailwindCSS JIT 模式
   - 组件懒加载
   - CDN 加速

### 后端优化

1. **数据库优化**
   - 索引优化
   - 连接池配置
   - 查询优化

2. **缓存策略**
   - 内存缓存 (node-cache)
   - access_token 缓存
   - jsapi_ticket 缓存

3. **并发处理**
   - 异步处理
   - 事务管理
   - 错误处理

---

## 十、已知问题和风险

### 安全问题

1. ✅ **后门代码** - monitor.js 恶意模块
2. ⚠️ **CORS 配置过于宽松** - 允许所有来源
3. ⚠️ **没有请求频率限制** - 容易被攻击
4. ⚠️ **SQL 注入风险** - 部分查询未使用参数化
5. ⚠️ **XSS 风险** - 部分输出未过滤

### 架构问题

1. ⚠️ **单点故障** - 没有高可用设计
2. ⚠️ **缺少日志系统** - 难以追踪问题
3. ⚠️ **缺少监控** - 无法及时发现问题
4. ⚠️ **缺少备份** - 数据丢失风险

### 代码质量问题

1. ⚠️ **代码混淆** - 难以维护
2. ⚠️ **缺少测试** - 没有单元测试
3. ⚠️ **错误处理不完善** - 容易崩溃
4. ⚠️ **缺少文档** - 难以理解

---

## 十一、技术债务

### 需要改进的地方

1. **安全加固**
   - 移除后门代码
   - 添加输入验证
   - 实现请求限流
   - 加强权限控制

2. **代码重构**
   - 解除代码混淆
   - 模块化改造
   - 添加 TypeScript（后端）
   - 统一错误处理

3. **功能完善**
   - 添加日志系统
   - 添加监控告警
   - 实现数据备份
   - 添加单元测试

4. **性能优化**
   - Redis 缓存
   - 数据库读写分离
   - CDN 加速
   - 负载均衡

---

## 十二、技术选型评价

### 优点

1. **现代化技术栈**
   - Next.js + React 19
   - ES Modules
   - TypeScript (前端)

2. **功能完整**
   - 用户系统完整
   - 支付集成多样
   - 管理后台完善

3. **易于部署**
   - 单机部署简单
   - 配置相对清晰

### 缺点

1. **安全性差**
   - 存在后门
   - 缺少安全措施

2. **可维护性差**
   - 代码混淆
   - 缺少文档
   - 缺少测试

3. **扩展性差**
   - 单体架构
   - 紧耦合设计

---

## 十三、改进建议

如果要继续使用此系统，建议按以下优先级改进：

### P0（必须立即修复）
1. 移除所有后门代码
2. 修复 SQL 注入漏洞
3. 添加输入验证
4. 限制 CORS 来源

### P1（高优先级）
1. 添加请求频率限制
2. 实现日志系统
3. 添加错误监控
4. 配置数据备份

### P2（中优先级）
1. 代码解混淆和重构
2. 添加单元测试
3. 完善文档
4. 优化数据库查询

### P3（低优先级）
1. 微服务改造
2. 引入 Redis 缓存
3. 实现 CI/CD
4. 容器化部署

---

## 十四、总结

### 技术评分（满分10分）

- **功能完整性：** 8/10 ✅
- **代码质量：** 3/10 ⚠️
- **安全性：** 1/10 🔴
- **可维护性：** 3/10 ⚠️
- **性能：** 6/10 ✅
- **扩展性：** 4/10 ⚠️

**总体评分：** 4.2/10

### 最终建议

1. **不建议直接使用** - 存在严重安全隐患
2. **如果必须使用** - 必须彻底清理后门并加固安全
3. **长期使用** - 需要进行大规模重构
4. **商业使用** - 强烈建议重新开发或选择成熟方案

---

**分析日期：** 2025-10-16  
**分析工具：** AI架构分析系统  
**技术水平：** 中级（存在安全隐患）

